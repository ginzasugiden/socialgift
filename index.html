<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚®ãƒ•ãƒˆè¨­å®šä¾</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #fdf2f8;
    --surface: #ffffff;
    --surface-hover: #fce4ec;
    --border: #f9a8d4;
    --border-focus: #db2777;
    --text: #4a1942;
    --text-muted: #9d6b8a;
    --accent: #db2777;
    --accent-glow: rgba(219,39,119,0.18);
    --success: #16a34a;
    --success-bg: rgba(22,163,74,0.1);
    --error: #dc2626;
    --error-bg: rgba(220,38,38,0.08);
    --warning: #ea580c;
    --warning-bg: rgba(234,88,12,0.08);
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Noto Sans JP', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 18px 28px;
    display: flex;
    align-items: center;
    gap: 14px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, #db2777, #f472b6);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .header h1 {
    font-size: 16px; font-weight: 600;
    color: var(--text);
  }
  .header .subtitle {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
    margin-top: 1px;
  }

  /* â”€â”€â”€ Main Layout â”€â”€â”€ */
  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 28px 24px;
  }

  /* â”€â”€â”€ Credentials Panel â”€â”€â”€ */
  /* â”€â”€â”€ Auth Panel â”€â”€â”€ */
  .auth-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 22px;
    margin-bottom: 20px;
    transition: border-color .3s;
  }
  .auth-panel.authed { border-color: var(--success); }

  /* â”€â”€ Not logged in: login form â”€â”€ */
  .login-form { display: block; }
  .login-form .login-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .login-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .login-fields label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 4px;
    display: block;
  }
  .login-fields input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 12px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    outline: none;
    transition: border-color .2s;
  }
  .login-fields input:focus { border-color: var(--border-focus); }
  .login-fields input.err { border-color: var(--error); }
  .login-actions {
    margin-top: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .login-error {
    font-size: 12px;
    color: var(--error);
    margin-top: 8px;
    min-height: 16px;
    font-family: var(--mono);
  }

  /* â”€â”€ Logged in: user info bar â”€â”€ */
  .user-info { display: none; }
  .user-info-inner {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .user-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: linear-gradient(135deg, #db2777, #f472b6);
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
  }
  .user-details { flex: 1; min-width: 0; }
  .user-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .user-meta {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
    margin-top: 1px;
  }
  .user-meta .expiry-ok { color: var(--success); }
  .user-meta .expiry-warn { color: var(--warning); }
  .btn-logout {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    border-radius: 7px;
    padding: 5px 12px;
    font-size: 11px;
    font-family: var(--sans);
    cursor: pointer;
    transition: all .2s;
    flex-shrink: 0;
  }
  .btn-logout:hover { border-color: var(--error); color: var(--error); }

  /* â”€â”€â”€ Search Bar â”€â”€â”€ */
  .search-row {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .search-wrap {
    flex: 1;
    position: relative;
  }
  .search-wrap .icon-search {
    position: absolute; left: 13px; top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 16px;
    pointer-events: none;
  }
  .search-wrap input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 14px 11px 40px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    outline: none;
    transition: border-color .2s, box-shadow .2s;
  }
  .search-wrap input:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .search-wrap input::placeholder { color: var(--text-muted); }

  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 11px 22px;
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s, transform .1s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn:hover { background: #be185d; }
  .btn:active { transform: scale(0.97); }
  .btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; transform: none; }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { background: var(--surface-hover); color: var(--text); border-color: var(--border); }

  /* â”€â”€â”€ Results Header â”€â”€â”€ */
  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    min-height: 32px;
  }
  .results-count {
    font-size: 12px;
    color: var(--text-muted);
    font-family: var(--mono);
  }
  .results-count span { color: var(--accent); font-weight: 600; }
  .batch-actions {
    display: flex;
    gap: 8px;
  }
  .btn-sm {
    padding: 6px 14px;
    font-size: 12px;
    border-radius: 7px;
  }

  /* â”€â”€â”€ Item List â”€â”€â”€ */
  .item-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .item-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: border-color .2s, background .2s;
    animation: slideIn .25s ease both;
  }
  .item-card:hover { border-color: var(--border-focus); background: var(--surface-hover); }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Checkbox Toggle */
  .toggle-wrap {
    position: relative;
    width: 46px; height: 26px;
    flex-shrink: 0;
  }
  .toggle-wrap input {
    opacity: 0; width: 0; height: 0;
  }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: #e9d5e0;
    border-radius: 13px;
    cursor: pointer;
    transition: background .25s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    left: 3px; bottom: 3px;
    background: #fff;
    border-radius: 50%;
    transition: transform .25s;
  }
  .toggle-wrap input:checked + .toggle-slider { background: var(--accent); }
  .toggle-wrap input:checked + .toggle-slider::before { transform: translateX(20px); }
  .toggle-wrap input:focus + .toggle-slider { box-shadow: 0 0 0 3px var(--accent-glow); }

  /* Item info */
  .item-info { flex: 1; min-width: 0; }
  .item-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .item-manage {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
    margin-top: 2px;
  }

  /* Status badge */
  .badge {
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 20px;
    letter-spacing: 0.3px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .badge-on { background: var(--accent-glow); color: var(--accent); }
  .badge-off { background: rgba(157,107,138,0.1); color: var(--text-muted); }
  .badge-pending { background: var(--warning-bg); color: var(--warning); }

  /* â”€â”€â”€ Action Bar (fixed bottom) â”€â”€â”€ */
  .action-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: rgba(253,242,248,0.92);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    transform: translateY(100%);
    transition: transform .3s cubic-bezier(.22,1,.36,1);
    z-index: 200;
  }
  .action-bar.visible { transform: translateY(0); }
  .action-bar .change-info {
    font-size: 13px;
    color: var(--text-muted);
  }
  .action-bar .change-info strong { color: var(--warning); }

  /* â”€â”€â”€ Log Panel â”€â”€â”€ */
  .log-panel {
    margin-top: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .log-header {
    padding: 10px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .log-body {
    padding: 14px 18px;
    font-family: var(--mono);
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    color: var(--text-muted);
  }
  .log-entry {
    padding: 4px 0;
    border-bottom: 1px solid rgba(219,39,119,0.1);
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .log-entry:last-child { border-bottom: none; }
  .log-time { color: #9d6b8a; flex-shrink: 0; }
  .log-ok { color: var(--success); }
  .log-err { color: var(--error); }
  .log-info { color: var(--accent); }

  /* â”€â”€â”€ Empty / Loading States â”€â”€â”€ */
  .state-msg {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-muted);
    font-size: 14px;
  }
  .state-msg .emoji { font-size: 32px; margin-bottom: 10px; }
  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€â”€ Toast â”€â”€â”€ */
  .toast {
    position: fixed;
    top: 24px; right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(219,39,119,0.12);
    z-index: 300;
    transform: translateX(calc(100% + 40px));
    transition: transform .35s cubic-bezier(.22,1,.36,1);
    max-width: 340px;
  }
  .toast.show { transform: translateX(0); }
  .toast.success { border-color: var(--success); }
  .toast.error { border-color: var(--error); }
  .toast .toast-title { font-weight: 600; margin-bottom: 2px; }
  .toast.success .toast-title { color: var(--success); }
  .toast.error .toast-title { color: var(--error); }
  .toast .toast-body { color: var(--text-muted); font-size: 12px; }
</style>
<script src="config.js"></script>
</head>
<body>

<!-- Header -->
<div class="header">
   <div class="header-icon">ğŸ</div>
  <div>
    <h1>ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚®ãƒ•ãƒˆè¨­å®šä¾</h1>
    <div class="subtitle">Rakuten ItemAPI 2.0 â€” features.socialGiftFlag</div>
  </div>
</div>

<!-- Main -->
<div class="container">

  <!-- Auth Panel -->
  <div class="auth-panel" id="authPanel">

    <!-- â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³å‰ â”€â”€ -->
    <div class="login-form" id="loginForm">
      <div class="login-title">ğŸ” &nbsp;ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="login-fields">
        <div>
          <label>ID</label>
          <input type="text"     id="inputId" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" autocomplete="off">
        </div>
        <div>
          <label>PW</label>
          <input type="password" id="inputPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off"
                 onkeydown="if(event.key==='Enter') doLogin()">
        </div>
      </div>
      <div class="login-actions">
        <button class="btn btn-sm" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <span id="loginSpinner" style="display:none;"><span class="spinner"></span></span>
      </div>
      <div class="login-error" id="loginError"></div>
    </div>

    <!-- â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ â”€â”€ -->
    <div class="user-info" id="userInfo">
      <div class="user-info-inner">
        <div class="user-avatar">âœ“</div>
        <div class="user-details">
          <div class="user-name" id="userName">âˆ’</div>
          <div class="user-meta" id="userMeta">âˆ’</div>
        </div>
        <button class="btn-logout" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

  </div>

  <!-- Search -->
  <div class="search-row">
    <div class="search-wrap">
      <span class="icon-search">ğŸ”</span>
      <input type="text" id="searchInput"
             placeholder="å•†å“ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ï¼ˆç©ºæ¬„ï¼å…¨å•†å“ä¸€è¦§ï¼‰"
             id="searchInput">
    </div>
    <button class="btn" id="btnSearch" onclick="handleSearch()">æ¤œç´¢</button>
  </div>

  <!-- Results -->
  <div class="results-header" id="resultsHeader" style="display:none;">
    <div class="results-count">æ¤œç´¢çµæœï¼š<span id="countNum">0</span> ä»¶</div>
    <div class="batch-actions">
      <button class="btn btn-ghost btn-sm" onclick="selectAll(true)">å…¨ãƒã‚§ãƒƒã‚¯</button>
      <button class="btn btn-ghost btn-sm" onclick="selectAll(false)">å…¨ã‚¢ãƒ³ãƒã‚§ãƒƒã‚¯</button>
    </div>
  </div>

  <div id="itemList" class="item-list">
    <div class="state-msg">
      <div class="emoji">ğŸ”</div>
      æ¤œç´¢ã—ã¦å•†å“ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„
    </div>
  </div>

  <!-- Log -->
  <div class="log-panel" id="logPanel" style="display:none;">
    <div class="log-header">
      ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°
      <button class="btn btn-ghost btn-sm" onclick="clearLog()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="log-body" id="logBody"></div>
  </div>
</div>

<!-- Action Bar (fixed bottom) -->
<div class="action-bar" id="actionBar">
  <div class="change-info">
    <strong id="changeCount">0</strong> ä»¶ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™
  </div>
  <button class="btn" id="btnUpdate" onclick="applyChanges()">å¤‰æ›´ã‚’é©ç”¨</button>
  <button class="btn btn-ghost btn-sm" onclick="revertChanges()">å…ƒã«æˆ»ã™</button>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-title" id="toastTitle"></div>
  <div class="toast-body" id="toastBody"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let items = [];           // { manageNumber, title, original, current }
let logs = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGï¼ˆconfig.js ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAS_AUTH_URLãƒ»ACCESS_TOKEN ã¯ config.js ã® APP_CONFIG ã§å®šç¾©

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authState = {
  loggedIn:      false,
  licenseKey:    '',
  serviceSecret: '',
  sname:         '',
  expiry:        ''
};

// â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ â”€â”€
async function doLogin() {
  const id = document.getElementById('inputId').value.trim();
  const pw = document.getElementById('inputPw').value.trim();
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';
  document.getElementById('inputId').classList.remove('err');
  document.getElementById('inputPw').classList.remove('err');

  if (!id || !pw) {
    errEl.textContent = 'IDã¨PWã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    if (!id) document.getElementById('inputId').classList.add('err');
    if (!pw) document.getElementById('inputPw').classList.add('err');
    return;
  }

  // ã‚¹ãƒ”ãƒŠãƒ¼
  document.getElementById('loginSpinner').style.display = 'inline';
  document.getElementById('btnLogin') && (document.querySelector('.login-actions .btn').disabled = true);

  try {
    const url = APP_CONFIG.GAS_AUTH_URL
      + '?token=' + encodeURIComponent(APP_CONFIG.ACCESS_TOKEN)
      + '&id='    + encodeURIComponent(id)
      + '&pw='    + encodeURIComponent(pw);
    const res  = await fetch(url);
    const data = await res.json();

    if (data.ok) {
      // èªè¨¼æˆåŠŸ â†’ çŠ¶æ…‹ã‚’ä¿æŒ
      authState = {
        loggedIn:      true,
        licenseKey:    data.licenseKey,
        serviceSecret: data.serviceSecret,
        sname:         data.sname,
        expiry:        data.expiry
      };
      renderAuthUI();
      addLog('info', `ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${data.sname}`);
    } else {
      errEl.textContent = data.error || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
      document.getElementById('inputPw').classList.add('err');
      document.getElementById('inputPw').value = '';
      document.getElementById('inputPw').focus();
    }
  } catch (e) {
    errEl.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }

  // ã‚¹ãƒ”ãƒŠãƒ¼OFF
  document.getElementById('loginSpinner').style.display = 'none';
  document.querySelector('.login-actions .btn').disabled = false;
}

// â”€â”€ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ â”€â”€
function doLogout() {
  authState = { loggedIn: false, licenseKey: '', serviceSecret: '', sname: '', expiry: '' };
  document.getElementById('inputId').value = '';
  document.getElementById('inputPw').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('authPanel').classList.remove('authed');
  renderAuthUI();
  // å•†å“ä¸€è¦§ã‚‚ãƒªã‚»ãƒƒãƒˆ
  items = [];
  document.getElementById('itemList').innerHTML =
    '<div class="state-msg"><div class="emoji">ğŸ”</div>æ¤œç´¢ã—ã¦å•†å“ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</div>';
  document.getElementById('resultsHeader').style.display = 'none';
  updateActionBar();
}

// â”€â”€ UI åˆ‡ã‚Šæ›¿ãˆ â”€â”€
function renderAuthUI() {
  const loginForm = document.getElementById('loginForm');
  const userInfo  = document.getElementById('userInfo');
  const panel     = document.getElementById('authPanel');

  if (authState.loggedIn) {
    loginForm.style.display = 'none';
    userInfo.style.display  = 'block';
    panel.classList.add('authed');

    document.getElementById('userName').textContent = authState.sname || 'Unknown';

    // expiry è¡¨ç¤º
    let metaHtml = '';
    if (authState.expiry) {
      const exp   = new Date(authState.expiry);
      const now   = new Date();
      const days  = Math.ceil((exp - now) / (1000*60*60*24));
      const cls   = days <= 7 ? 'expiry-warn' : 'expiry-ok';
      const label = days <= 0 ? 'æœŸé™åˆ‡ã‚Œ' : `æ®‹ã‚Š ${days} æ—¥`;
      metaHtml = `æœŸé™: <span class="${cls}">${label}</span>`;
    }
    document.getElementById('userMeta').innerHTML = metaHtml;
  } else {
    loginForm.style.display = 'block';
    userInfo.style.display  = 'none';
  }
}

// â”€â”€ èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—ï¼ˆä»–ã®é–¢æ•°ã‹ã‚‰å‘¼ã¶ï¼‰ â”€â”€
/*
  function getAuth() {
  if (!authState.loggedIn) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'ã¾ãšèªè¨¼ãƒ‘ãƒãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
    return null;
  }
  return 'ESA ' + btoa(authState.serviceSecret + ':' + authState.licenseKey);
}
*/
  
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// const API_BASE = 'https://api.rms.rakuten.co.jp/es/2.0/items/manage-numbers';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLSï¼ˆGASãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function apiGet(manageNumber) {
  const url = APP_CONFIG.GAS_AUTH_URL
    + '?token=' + encodeURIComponent(APP_CONFIG.ACCESS_TOKEN)
    + '&action=get'
    + '&ss='    + encodeURIComponent(authState.serviceSecret)
    + '&lk='    + encodeURIComponent(authState.licenseKey)
    + '&mn='    + encodeURIComponent(manageNumber);
  
  const res = await fetch(url);
  return res.json();
}

async function apiPatch(manageNumber, socialGiftFlag) {
  const url = APP_CONFIG.GAS_AUTH_URL
    + '?token=' + encodeURIComponent(APP_CONFIG.ACCESS_TOKEN)
    + '&action=patch'
    + '&ss='    + encodeURIComponent(authState.serviceSecret)
    + '&lk='    + encodeURIComponent(authState.licenseKey)
    + '&mn='    + encodeURIComponent(manageNumber)
    + '&sgf='   + (socialGiftFlag ? 'true' : 'false');
  
  const res = await fetch(url);
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleSearch() {
  if (!authState.loggedIn) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'ã¾ãšèªè¨¼ãƒ‘ãƒãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const query = document.getElementById('searchInput').value.trim();
  const list  = document.getElementById('itemList');

  list.innerHTML = '<div class="state-msg"><span class="spinner"></span> æ¤œç´¢ä¸­â€¦</div>';
  document.getElementById('resultsHeader').style.display = 'none';

  if (query === '') {
    list.innerHTML = `
      <div class="state-msg">
        <div class="emoji">ğŸ’¡</div>
        <strong>å…¨å•†å“ä¸€è¦§ã®å–å¾—ã«ã¯ç®¡ç†ç•ªå·ãŒå¿…è¦ã§ã™</strong><br>
        <span style="font-size:12px; color:var(--text-muted); margin-top:4px; display:inline-block;">
          æ¥½å¤© ItemAPI 2.0ã«ã¯ã€Œå…¨ä»¶å–å¾—ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãªã„ãŸã‚ã€<br>
          GASã®ã‚·ãƒ¼ãƒˆã‹ã‚‰å•†å“ç®¡ç†ç•ªå·ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è²¼ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚<br>
          ä¾‹ï¼š<code style="color:var(--accent)">item001,item002,item003</code>
        </span>
      </div>`;
    return;
  }

  // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯¾å¿œ
  const manageNumbers = query.split(',').map(s => s.trim()).filter(Boolean);
  items = [];

  for (const mn of manageNumbers) {
    try {
      const result = await apiGet(mn);
      
      if (result.ok && result.data) {
        const data = result.data;
        const flag = data.features?.socialGiftFlag ?? false;
        items.push({
          manageNumber: data.manageNumber,
          title:        data.title || '(å•†å“åãªã—)',
          original:     flag,
          current:      flag
        });
        addLog('info', `GET ${mn} â†’ socialGiftFlag: ${flag}`);
      } else {
        const errMsg = result.data?.errors?.[0]?.message || result.error || 'ã‚¨ãƒ©ãƒ¼';
        addLog('err', `GET ${mn} â†’ ${result.status || ''} ${errMsg}`);
      }
    } catch (e) {
      addLog('err', `GET ${mn} â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼`);
    }
  }

  renderList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderList() {
  const list = document.getElementById('itemList');
  document.getElementById('resultsHeader').style.display = 'flex';
  document.getElementById('countNum').textContent = items.length;

  if (items.length === 0) {
    list.innerHTML = '<div class="state-msg"><div class="emoji">ğŸ“­</div>è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    return;
  }

  list.innerHTML = items.map((item, i) => `
    <div class="item-card" style="animation-delay:${i * 0.04}s">
      <div class="toggle-wrap">
        <input type="checkbox" id="chk_${i}" ${item.current ? 'checked' : ''}
               onchange="toggleItem(${i})">
        <label class="toggle-slider" for="chk_${i}"></label>
      </div>
      <div class="item-info">
        <div class="item-title">${escHtml(item.title)}</div>
        <div class="item-manage">${escHtml(item.manageNumber)}</div>
      </div>
      <span class="badge ${item.current ? 'badge-on' : 'badge-off'}" id="badge_${i}">
        ${item.current ? 'å¯¾å¿œã™ã‚‹' : 'å¯¾å¿œã—ãªã„'}
      </span>
      ${item.current !== item.original
        ? `<span class="badge badge-pending" id="pending_${i}">å¤‰æ›´å¾…ã¡</span>`
        : `<span style="width:50px" id="pending_${i}"></span>`}
    </div>
  `).join('');

  updateActionBar();
}

function toggleItem(idx) {
  items[idx].current = document.getElementById(`chk_${idx}`).checked;
  // badge update
  const badge = document.getElementById(`badge_${idx}`);
  badge.className = 'badge ' + (items[idx].current ? 'badge-on' : 'badge-off');
  badge.textContent = items[idx].current ? 'å¯¾å¿œã™ã‚‹' : 'å¯¾å¿œã—ãªã„';
  // pending badge
  const pending = document.getElementById(`pending_${idx}`);
  if (items[idx].current !== items[idx].original) {
    pending.className = 'badge badge-pending';
    pending.textContent = 'å¤‰æ›´å¾…ã¡';
  } else {
    pending.className = '';
    pending.textContent = '';
    pending.style.width = '50px';
  }
  updateActionBar();
}

function selectAll(val) {
  items.forEach((item, i) => {
    item.current = val;
    document.getElementById(`chk_${i}`).checked = val;
  });
  renderList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTION BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateActionBar() {
  const changes = items.filter(it => it.current !== it.original).length;
  document.getElementById('changeCount').textContent = changes;
  const bar = document.getElementById('actionBar');
  bar.classList.toggle('visible', changes > 0);
}

function revertChanges() {
  items.forEach(it => { it.current = it.original; });
  renderList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLY (PATCH)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function applyChanges() {
  if (!authState.loggedIn) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'ã¾ãšèªè¨¼ãƒ‘ãƒãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const toUpdate = items.filter(it => it.current !== it.original);
  if (toUpdate.length === 0) return;

  const btn = document.getElementById('btnUpdate');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> æ›´æ–°ä¸­â€¦';

  let success = 0, fail = 0;

  for (const item of toUpdate) {
    try {
      const result = await apiPatch(item.manageNumber, item.current);

      if (result.ok) {
        item.original = item.current;
        success++;
        addLog('ok', `PATCH ${item.manageNumber} â†’ socialGiftFlag: ${item.current}`);
      } else {
        const errMsg = result.data?.errors?.[0]?.message || result.error || 'ã‚¨ãƒ©ãƒ¼';
        fail++;
        addLog('err', `PATCH ${item.manageNumber} â†’ ${result.status || ''} ${errMsg}`);
      }
    } catch (e) {
      fail++;
      addLog('err', `PATCH ${item.manageNumber} â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼`);
    }
  }

  btn.disabled = false;
  btn.innerHTML = 'å¤‰æ›´ã‚’é©ç”¨';
  renderList();

  if (fail === 0) {
    showToast('æ›´æ–°å®Œäº†', `${success} ä»¶ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚®ãƒ•ãƒˆè¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ`, 'success');
  } else {
    showToast('ä¸€éƒ¨å¤±æ•—', `æˆåŠŸ: ${success} ä»¶ / å¤±æ•—: ${fail} ä»¶ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(type, msg) {
  const now = new Date();
  const time = now.toLocaleTimeString('ja-JP', { hour12: false });
  logs.unshift({ type, time, msg });
  renderLog();
}

function renderLog() {
  const panel = document.getElementById('logPanel');
  const body  = document.getElementById('logBody');
  panel.style.display = 'block';
  body.innerHTML = logs.map(l => `
    <div class="log-entry">
      <span class="log-time">${l.time}</span>
      <span class="log-${l.type}">${escHtml(l.msg)}</span>
    </div>
  `).join('');
}

function clearLog() {
  logs = [];
  document.getElementById('logPanel').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(title, body, type) {
  const t = document.getElementById('toast');
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastBody').textContent = body;
  t.className = 'toast ' + type;
  // force reflow
  void t.offsetWidth;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
